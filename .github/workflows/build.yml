name: Build Docker Images

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build unbuilt or modified module versions
        run: |
          set -euo pipefail

          echo "Detecting module directories…"
          mapfile -t MODULES < <(
            find . -maxdepth 1 -mindepth 1 -type d | while read -r d; do
              if [[ -f "$d/versions.json" ]]; then
                echo "$d"
              fi
            done
          )

          echo "Modules detected: ${MODULES[*]}"

          echo "Computing changed files…"
          git fetch --depth=2 origin ${{ github.ref }} || true
          mapfile -t CHANGED < <(git diff --name-only ${{ github.event.before }} ${{ github.sha }} || true)

          echo "Changed files:"
          printf '%s\n' "${CHANGED[@]}"

          for module in "${MODULES[@]}"; do
            echo ""
            echo "=================================="
            echo "Processing module: $module"
            echo "=================================="

            VFILE="$module/versions.json"
            DF="$module/Dockerfile"
            BSH="$module/build.sh"
            BFSH="$module/build_firmware.sh"

            FORCE_REBUILD=false

            echo "Checking if module requires forced rebuild…"

            for f in "${CHANGED[@]}"; do
              if [[ "$f" == "$DF" ]] || [[ "$f" == "$BSH" ]] || [[ "$f" == "$BFSH" ]]; then
                echo "Detected change affecting module: $f"
                FORCE_REBUILD=true
                break
              fi
            done

            if [[ "$FORCE_REBUILD" == true ]]; then
              echo "Forcing full rebuild for $module"
              jq 'map(.built = false)' "$VFILE" > "$VFILE.tmp"
              mv "$VFILE.tmp" "$VFILE"
            fi

            # Determine what needs to be built
            mapfile -t TO_BUILD < <(jq -c '.[] | select(.built == false)' "$VFILE")

            if [[ ${#TO_BUILD[@]} -eq 0 ]]; then
              echo "No builds needed for $module"
              continue
            fi

            echo "Versions to build for $module: ${#TO_BUILD[@]}"

            # Build missing versions
            for item in "${TO_BUILD[@]}"; do
              MPY=$(jq -r '.mpy' <<< "$item")
              IDF=$(jq -r '.idf // empty' <<< "$item")       # optional for non-ESP modules
              TAG=$(jq -r '.tag' <<< "$item")

              echo ""
              echo "--- Building ${module#./}:$TAG ---"

              docker build \
                -f "$DF" \
                --build-arg MPY_VERSION="$MPY" \
                $( [[ -n "$IDF" ]] && echo "--build-arg IDF_VERSION=$IDF" ) \
                -t ${{ secrets.DOCKERHUB_USERNAME }}/${module#./}:"$TAG" \
                "$module"

              docker push ${{ secrets.DOCKERHUB_USERNAME }}/${module#./}:"$TAG"

              # Mark version as built
              jq "(map(if .tag == \"$TAG\" then .built = true else . end))" \
                "$VFILE" > "$VFILE.tmp"
              mv "$VFILE.tmp" "$VFILE"
            done
          done

      - name: Commit updated versions.json files
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add */versions.json
          git commit -m "Update built flags after builds" || echo "No JSON changes to commit"
          git push
