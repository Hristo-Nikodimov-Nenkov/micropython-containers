name: Build and Push MicroPython Containers

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write  # needed to commit versions.json updates

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build containers
        run: |
          set -euo pipefail

          # Find directories with Dockerfile
          DIRS=$(find . -mindepth 1 -maxdepth 1 -type d \
            ! -name ".github" ! -name "." \
            -exec test -f "{}/Dockerfile" \; -print | sed 's|^\./||')

          for DIR in $DIRS; do
              echo "Processing directory: $DIR"

              if [[ ! -f "$DIR/versions.json" ]]; then
                  echo "No versions.json found in $DIR, skipping."
                  continue
              fi

              UNBUILT=$(jq '[.[] | select(.built==false)]' "$DIR/versions.json")
              COUNT=$(echo "$UNBUILT" | jq length)

              if [[ "$COUNT" -eq 0 ]]; then
                  echo "All versions already built for $DIR, skipping."
                  continue
              fi

              echo "Found $COUNT unbuilt version(s) in $DIR"

              for i in $(seq 0 $((COUNT - 1))); do
                  ENTRY=$(echo "$UNBUILT" | jq ".[$i]")

                  # Convert JSON properties to flags, ignore dir & built
                  FLAGS=$(echo "$ENTRY" | jq -r 'to_entries | map(select(.key != "dir" and .key != "built") | "--\(.key) \"\(.value)\"") | join(" ")')

                  echo "-----------------------------------------"
                  echo "Running build.sh for $DIR with flags: $FLAGS"
                  echo "-----------------------------------------"

                  cd "$DIR"
                  chmod +x build.sh
                  # shellcheck disable=SC2086
                  eval ./build.sh "${{ secrets.DOCKERHUB_USERNAME }}" $FLAGS
                  cd - >/dev/null

                  # Mark as built
                  TAG=$(echo "$ENTRY" | jq -r '.tag')
                  jq "map(if .tag==\"$TAG\" then .built=true else . end)" versions.json > versions.tmp.json
                  mv versions.tmp.json versions.json
              done
          done

      - name: Commit updated versions.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add */versions.json || echo "No changes to add"
          if ! git diff --cached --quiet; then
            git commit -m "Update built status in versions.json"
            git push
          else
            echo "No versions.json changes to commit"
          fi
