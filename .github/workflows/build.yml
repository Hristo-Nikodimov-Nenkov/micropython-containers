name: Build and Push MicroPython Containers

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repo with full history
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0   # fetch all commits so git diff works

      # Step 2: DockerHub login
      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Step 3: Determine changed directories and build matrix
      - id: dirs
        run: |
          set -euo pipefail

          # Fetch main branch to compare against
          git fetch origin main

          # Get changed files relative to main
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD || true)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Find directories with Dockerfile
          DIRS=$(find . -mindepth 1 -maxdepth 1 -type d \
            ! -name ".github" ! -name "." \
            -exec test -f "{}/Dockerfile" \; -print | sed 's|^\./||')

          MATRIX="[]"

          for DIR in $DIRS; do
            DIR_CHANGED=false

            while read -r FILE; do
              [[ -z "$FILE" ]] && continue
              [[ "$(basename "$FILE")" == "README.md" ]] && continue
              if [[ "$FILE" == "$DIR/"* ]]; then
                DIR_CHANGED=true
                break
              fi
            done <<< "$CHANGED_FILES"

            if ! $DIR_CHANGED; then
              echo "Skipping $DIR (no meaningful change)"
              continue
            fi

            if [[ -f "$DIR/versions.json" ]]; then
              ITEMS=$(jq --arg d "$DIR" '[ .[] | .dir=$d ]' "$DIR/versions.json")
              MATRIX=$(jq -n --argjson a "$MATRIX" --argjson b "$ITEMS" '$a + $b')
            fi
          done

          echo "Final build matrix:"
          echo "$MATRIX"

          # Write matrix for GitHub Actions
          {
            echo "matrix<<EOF"
            echo "{ \"include\": $MATRIX }"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # Step 4: Build & push images
      - name: Build & Push containers
        run: |
          set -euo pipefail

          MATRIX='${{ steps.dirs.outputs.matrix }}'
          COUNT=$(echo "$MATRIX" | jq '.include | length')

          if [[ "$COUNT" -eq 0 ]]; then
            echo "No builds required."
            exit 0
          fi

          echo "Building $COUNT image(s)..."

          for i in $(seq 0 $((COUNT - 1))); do
            ENTRY=$(echo "$MATRIX" | jq ".include[$i]")

            DIR=$(echo "$ENTRY" | jq -r '.dir')

            # Convert JSON fields (except dir) â†’ CLI flags
            FLAGS=$(echo "$ENTRY" | jq -r '
              to_entries |
              map(select(.key != "dir") | "--\(.key) \"\(.value)\"") |
              join(" ")
            ')

            echo "-----------------------------------------"
            echo "Building directory: $DIR"
            echo "Flags: $FLAGS"
            echo "-----------------------------------------"

            cd "$DIR"
            chmod +x build.sh

            USER="${{ secrets.DOCKERHUB_USERNAME }}"

            # Run the directory-specific build.sh
            # shellcheck disable=SC2086
            eval ./build.sh "$USER" $FLAGS

            cd - >/dev/null
          done

          echo "All builds complete."
