name: Build and Push Docker Containers

on:
  push:
    paths:
      - '**/Dockerfile'
      - '**/build_firmware.sh'
      - '**/build.sh'
      - '**/versions.json'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Log in to DockerHub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Determine changed directories
        id: changes
        run: |
          # Fetch commits to access .last_build_commit if needed
          git fetch origin --depth=2

          # Determine changed files
          if [ -f ".last_build_commit" ]; then
            LAST_SHA=$(cat .last_build_commit)
            echo "Last workflow commit: $LAST_SHA"
            CHANGED_FILES=$(git diff --name-only "$LAST_SHA" HEAD)
          elif git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            # First commit, take all files
            echo "First commit detected, building all directories."
            CHANGED_FILES=$(git ls-files)
          fi

          ALL_CHANGED_DIRS=()
          REBUILD_ALL=false

          for FILE in $CHANGED_FILES; do
            DIR=$(dirname "$FILE")
            # Dockerfile, build.sh or build_firmware.sh triggers full rebuild
            if [[ "$FILE" == */Dockerfile || "$FILE" == */build.sh || "$FILE" == */build_firmware.sh ]]; then
              REBUILD_ALL=true
            fi
            if [[ ! " ${ALL_CHANGED_DIRS[@]} " =~ " ${DIR} " ]]; then
              ALL_CHANGED_DIRS+=("$DIR")
            fi
          done

          echo "ALL_CHANGED_DIRS=${ALL_CHANGED_DIRS[*]}" >> $GITHUB_ENV
          echo "REBUILD_ALL=$REBUILD_ALL" >> $GITHUB_ENV

      - name: Build and push Docker images
        run: |
          CHANGED_VERSIONS=()

          for DIR in $ALL_CHANGED_DIRS; do
            echo "Processing directory: $DIR"

            VERSIONS_FILE="$DIR/versions.json"
            UPDATED=false

            for i in $(seq 0 $(($(jq length "$VERSIONS_FILE") - 1))); do
              VERSION=$(jq -c ".[$i]" "$VERSIONS_FILE")
              BUILT=$(echo "$VERSION" | jq -r '.built // false')

              # Map all properties to flags
              FLAGS=""
              for key in $(echo "$VERSION" | jq -r 'keys[]'); do
                value=$(echo "$VERSION" | jq -r ".${key}")
                FLAGS="$FLAGS --$key $value"
              done

              if [[ "$REBUILD_ALL" == "true" || "$BUILT" == "false" ]]; then
                FLAGS="$FLAGS --built false"
                echo "Building image $DIR with flags $FLAGS"

                if bash "$DIR/build.sh" "$DOCKERHUB_USERNAME" "$DIR" $FLAGS; then
                  echo "Build succeeded, updating versions.json..."
                  jq ".[$i].built = true" "$VERSIONS_FILE" > "$VERSIONS_FILE.tmp" && mv "$VERSIONS_FILE.tmp" "$VERSIONS_FILE"
                  UPDATED=true
                else
                  echo "Build failed for $DIR"
                  exit 1
                fi
              else
                echo "Skipping image in $DIR (already built)"
              fi
            done

            if [ "$UPDATED" = true ]; then
              CHANGED_VERSIONS+=("$VERSIONS_FILE")
            fi
          done

          # Commit all updated versions.json and update last workflow commit
          if [ ${#CHANGED_VERSIONS[@]} -gt 0 ]; then
            echo "Committing updated versions.json files..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "${CHANGED_VERSIONS[@]}"
            echo "$GITHUB_SHA" > .last_build_commit
            git add .last_build_commit
            git commit -m "Update built status and last workflow commit after successful Docker builds"
            git push
          else
            echo "No versions.json files changed, skipping commit."
          fi