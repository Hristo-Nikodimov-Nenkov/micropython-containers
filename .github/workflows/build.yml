name: Build and Push MicroPython Containers

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.gen.outputs.matrix }}
    steps:
      - uses: actions/checkout@v3

      - id: gen
        run: |
          echo "Scanning directories..."

          # --------------------------------------------------------
          # Find directories containing a Dockerfile
          # --------------------------------------------------------
          DIRS=$(find . -mindepth 1 -maxdepth 1 -type d \
            ! -name ".github" ! -name "." \
            -exec test -f "{}/Dockerfile" \; -print | sed 's|^\./||')

          echo "Found directories:"
          echo "$DIRS"

          # --------------------------------------------------------
          # Detect changed files (safe even on first commit)
          # --------------------------------------------------------
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
              echo "Repository has multiple commits — using git diff."
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
              echo "Only one commit exists — rebuilding all directories."
              CHANGED_FILES=$(git ls-files)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          MATRIX="[]"

          for DIR in $DIRS; do
            DIR_CHANGED=false

            echo "Checking directory: $DIR"

            # --------------------------------------------------------
            # Check if any file in this directory changed (except README.md)
            # --------------------------------------------------------
            while read -r FILE; do
              # Skip README.md
              [[ "$(basename "$FILE")" == "README.md" ]] && continue

              # File inside this directory?
              if [[ "$FILE" == "$DIR/"* ]]; then
                DIR_CHANGED=true
                break
              fi
            done <<< "$CHANGED_FILES"

            if ! $DIR_CHANGED; then
              echo " → No relevant changes in $DIR (or only README.md). Skipping."
              continue
            fi

            echo " → Changes detected in $DIR"

            # --------------------------------------------------------
            # Load versions.json in this directory
            # --------------------------------------------------------
            if [[ -f "$DIR/versions.json" ]]; then
              ITEMS=$(jq --arg d "$DIR" '[ .[] | .dir=$d ]' "$DIR/versions.json")
              MATRIX=$(jq -n --argjson a "$MATRIX" --argjson b "$ITEMS" '$a + $b')
            else
              echo "WARNING: $DIR has no versions.json — skipping."
            fi
          done

          echo "Final build matrix:"
          echo "$MATRIX"

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT


  # --------------------------------------------------------------------------
  # Build and Push
  # --------------------------------------------------------------------------
  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.prepare.outputs.matrix) }}
      fail-fast: false

    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

    steps:
      - uses: actions/checkout@v3

      # DockerHub login
      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build container
        run: |
          DIR="${{ matrix.dir }}"

          echo "Directory: $DIR"
          echo "Using DockerHub user: $DOCKERHUB_USERNAME"

          # Convert all JSON key-value pairs to CLI flags:
          #   key=value → --key "value"
          FLAGS=$(jq -r '
            to_entries |
            map(select(.key != "dir") | "--\(.key) \"\(.value)\"") |
            join(" ")
          ' <<< '${{ toJSON(matrix) }}')

          echo "Flags: $FLAGS"

          chmod +x "$DIR/build.sh"
          cd "$DIR"

          # Pass DockerHub username as the first parameter.
          # shellcheck disable=SC2086
          eval ./build.sh "$DOCKERHUB_USERNAME" $FLAGS
