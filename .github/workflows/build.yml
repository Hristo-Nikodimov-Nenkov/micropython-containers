name: Build and Push MicroPython Containers

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # Authenticate to DockerHub
      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine directories with relevant changes
        id: dirs
        run: |
          set -euo pipefail

          # If this is the first commit, avoid HEAD~1 errors
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          DIRS=$(find . -mindepth 1 -maxdepth 1 -type d \
            ! -name ".github" ! -name "." \
            -exec test -f "{}/Dockerfile" \; -print | sed 's|^\./||')

          MATRIX="[]"

          for DIR in $DIRS; do
            DIR_CHANGED=false

            while read -r FILE; do
              [[ -z "$FILE" ]] && continue
              [[ "$(basename "$FILE")" == "README.md" ]] && continue
              if [[ "$FILE" == "$DIR/"* ]]; then
                DIR_CHANGED=true
                break
              fi
            done <<< "$CHANGED_FILES"

            if ! $DIR_CHANGED; then
              echo "Skipping $DIR (no meaningful change)"
              continue
            fi

            if [[ -f "$DIR/versions.json" ]]; then
              ITEMS=$(jq --arg d "$DIR" '[ .[] | .dir=$d ]' "$DIR/versions.json")
              MATRIX=$(jq -n --argjson a "$MATRIX" --argjson b "$ITEMS" '$a + $b')
            fi
          done

          echo "Final build matrix:"
          echo "$MATRIX"

          echo "matrix={\"include\": $MATRIX}" >> $GITHUB_OUTPUT

      - name: Build & Push all required container images
        if: ${{ fromJSON(steps.dirs.outputs.matrix).include != null && fromJSON(steps.dirs.outputs.matrix).include != '' }}
        run: |
          set -euo pipefail

          MATRIX='${{ steps.dirs.outputs.matrix }}'
          COUNT=$(echo "$MATRIX" | jq '.include | length')

          if [[ "$COUNT" -eq 0 ]]; then
            echo "No builds required."
            exit 0
          fi

          echo "Building $COUNT image(s)..."

          # Loop over matrix entries manually
          for i in $(seq 0 $((COUNT - 1))); do
            ENTRY=$(echo "$MATRIX" | jq ".include[$i]")

            DIR=$(echo "$ENTRY" | jq -r '.dir')

            # Convert JSON fields (except dir) â†’ flags
            FLAGS=$(echo "$ENTRY" | jq -r '
              to_entries |
              map(select(.key != "dir") | "--\(.key) \"\(.value)\"") |
              join(" ")
            ')

            echo "-----------------------------------------"
            echo "Building directory: $DIR"
            echo "Flags: $FLAGS"
            echo "-----------------------------------------"

            cd "$DIR"
            chmod +x build.sh

            # Use DockerHub username from GitHub secret
            USER="${{ secrets.DOCKERHUB_USERNAME }}"

            # Run build.sh
            # shellcheck disable=SC2086
            eval ./build.sh "$USER" $FLAGS

            cd - >/dev/null
          done

          echo "All builds complete."
