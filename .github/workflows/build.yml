name: Build and Push Containers

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2   # needed for git diff

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Detect changed directories & build
        run: |
          set -euo pipefail

          echo "Detecting changed files..."
          CHANGED=$(git diff --name-only HEAD~1 HEAD || true)
          echo "$CHANGED"

          ROOT_DIR="$PWD"

          # detect directories containing Dockerfile
          DIRS=$(find . -mindepth 1 -maxdepth 1 -type d -exec test -f "{}/Dockerfile" \; -print | sed 's|^\./||')

          for DIR in $DIRS; do
            echo "-----------------------------------"
            echo "Checking directory: $DIR"

            # Check if any meaningful change happened
            CHANGED_IN_DIR=false
            while read -r FILE; do
              [[ -z "$FILE" ]] && continue
              [[ "$(basename "$FILE")" == "README.md" ]] && continue
              [[ "$FILE" == "$DIR/"* ]] && CHANGED_IN_DIR=true
            done <<< "$CHANGED"

            if ! $CHANGED_IN_DIR; then
              echo "Skipping $DIR (no meaningful change)"
              continue
            fi

            VERSION_FILE="$DIR/versions.json"

            if [[ ! -f "$VERSION_FILE" ]]; then
              echo "No versions.json in $DIR, skipping"
              continue
            fi

            echo "Loading versions.json from $VERSION_FILE"

            COUNT=$(jq 'length' "$VERSION_FILE")
            if [[ "$COUNT" -eq 0 ]]; then
              echo "WARNING: $VERSION_FILE has no versions defined, skipping"
              continue
            fi

            # iterate all versions that have built=false
            for i in $(seq 0 $((COUNT-1))); do
              BUILT=$(jq -r ".[$i].built" "$VERSION_FILE")
              TAG=$(jq -r ".[$i].tag" "$VERSION_FILE")
              MICROPYTHON=$(jq -r ".[$i].micropython" "$VERSION_FILE")

              # skip already built tags
              if [[ "$BUILT" == "true" ]]; then
                echo "Already built: $DIR / $TAG"
                continue
              fi

              echo "-----------------------------------------"
              echo "Running build.sh for $DIR"
              echo "  TAG=$TAG"
              echo "  MICROPYTHON=$MICROPYTHON"
              echo "-----------------------------------------"

              cd "$DIR"

              chmod +x build.sh

              # call build.sh with username and dynamic flags
              ./build.sh "${{ secrets.DOCKERHUB_USERNAME }}" \
                --tag "$TAG" \
                --micropython "$MICROPYTHON"

              cd "$ROOT_DIR"

              # mark version as built=true
              jq ".[$i].built = true" "$VERSION_FILE" > "$VERSION_FILE.tmp"
              mv "$VERSION_FILE.tmp" "$VERSION_FILE"
            done
          done

          echo "All builds completed."

      - name: Commit updated versions.json
        if: success()
        run: |
          set -e

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add */versions.json || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update built flags in versions.json"
          git push
