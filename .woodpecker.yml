when:
  event:
    - push
    - manual

workspace:
  base: /var/containers

steps:
  build_containers:
    image: alpine:latest
    environment:
      ROOT: /var/containers
      WORKSPACE: /var/containers
      DOCKERHUB_USERNAME:
        from_secret: DOCKERHUB_USERNAME
      DOCKERHUB_TOKEN:
        from_secret: DOCKERHUB_TOKEN
      GIT_USER_NAME:
        from_secret: GIT_USER_NAME
      GIT_USER_EMAIL:
        from_secret: GIT_USER_EMAIL
    commands:
      - apk add --no-cache bash jq curl git docker-cli

      - git config --global user.name "$GIT_USER_NAME"
      - git config --global user.email "$GIT_USER_EMAIL"
      - git config --global --add safe.directory "$WORKSPACE"

      - ls -al $ROOT/src

      - |
        SERVICES_JSON="$ROOT/services.json"
        if [ ! -f "$SERVICES_JSON" ]; then
          echo "ERROR: services.json missing at repo root"
          exit 2
        fi

      - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
